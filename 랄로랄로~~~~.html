<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ë³¸ì–´ í•™ìŠµ í†µí•© íˆ´ ğŸ‡¯ğŸ‡µ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* =====================================
           ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼
           ===================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f0f4f8; /* ë°ì€ ë°°ê²½ */
            min-height: 100vh; 
            display: flex; /* Flexbox ë ˆì´ì•„ì›ƒ ì‚¬ìš© */
            color: #2d3748;
        }
        
        /* ì‚¬ì´ë“œë°” ë©”ë‰´ */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            flex-shrink: 0; /* í¬ê¸° ê³ ì • */
        }
        .sidebar h1 { 
            font-size: 1.5em; 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 0 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }
        .sidebar-menu a {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            transition: background 0.3s;
            border-left: 5px solid transparent;
        }
        .sidebar-menu a:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }
        .sidebar-menu a.active {
            background: #4b6cb7;
            border-left: 5px solid #a0c4ff;
            font-weight: bold;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content-area {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            padding: 30px;
            overflow-y: auto; /* ë‚´ìš©ì´ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ */
        }
        .content-header { 
            margin-bottom: 30px; 
            color: #182848; 
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .main-card { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card { 
            background: white; 
            padding: 15px 30px; 
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 5px solid #4b6cb7;
            flex: 1;
            min-width: 150px;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #4b6cb7; }
        .stat-label { color: #666; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ì»¨íŠ¸ë¡¤ ë° ë²„íŠ¼ */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #4b6cb7; color: white; }
        .btn-primary:hover { background: #3a5aa0; transform: translateY(-1px); }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-secondary { background: #cbd5e0; color: #2d3748; }

        /* ì…ë ¥ í•„ë“œ */
        input[type="text"], select, textarea, .search-input { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; }
        input[type="text"]:focus, select:focus, textarea:focus, .search-input:focus { outline: none; border-color: #4b6cb7; }

        /* =====================================
           ë‹¨ì–´ ì¹´ë“œ ë° ê·¸ë¦¬ë“œ
           ===================================== */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .vocab-card { 
            background: linear-gradient(135deg, #a0c4ff 0%, #6d8db7 100%); 
            padding: 20px; 
            border-radius: 10px; 
            color: white; 
            transition: all 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .vocab-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .vocab-card.learned { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
            opacity: 0.9; 
            color: #4a5568; 
            border: 1px solid #90caf9;
        }
        .kanji { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .hiragana { font-size: 1.2em; margin-bottom: 10px; opacity: 0.9; }
        .meaning { font-size: 1em; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; }
        .vocab-card.learned .meaning { border-top: 1px solid rgba(0,0,0,0.1); }
        .card-actions { display: flex; gap: 5px; margin-top: 10px; }
        .card-actions button { flex: 1; padding: 8px; font-size: 0.85em; }
        
        /* ğŸ”Š ë°œìŒ ë²„íŠ¼ */
        .speak-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px;
            line-height: 1;
        }
        .vocab-card.learned .speak-btn { color: #4a5568; }

        /* ì•”ê¸° í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .memory-card {
            background: #fff;
            color: #2d3748;
            height: 250px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
            border: 3px solid #4b6cb7;
            transition: transform 0.5s, background 0.5s;
            position: relative; /* ë°œìŒ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ìœ„í•´ */
        }
        .memory-card.flipped { background: #e6fffa; }
        .memory-card .front { font-size: 3em; font-weight: bold; color: #4b6cb7; transition: opacity 0.3s; }
        .memory-card .back { color: #38a169; transition: opacity 0.3s; }
        
        .hidden-content { display: none; }
        .visible-content { display: block; }
        .card-footer { margin-top: 10px; font-size: 0.8em; color: #666; }
        
        /* ë ˆë²¨ í•„í„° ë“œë¡­ë‹¤ìš´ */
        #levelFilter { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; }


        /* =====================================
           ì „ì²´ ë‹¨ì–´ ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ìƒëµ)
           ===================================== */
        .wordlist-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .wordlist-table th, .wordlist-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .wordlist-table th { background-color: #4b6cb7; color: white; font-weight: bold; position: sticky; top: 0; z-index: 50; }
        .wordlist-table tr:hover { background-color: #f7fafc; }
        .wordlist-table td.status-learned { color: #48bb78; font-weight: bold; }
        .wordlist-table td.status-unlearned { color: #f56565; }
        .wordlist-actions button { padding: 5px 10px; font-size: 0.8em; }
        .level-section-title-table {
            background: #e9ecef;
            color: #4a5568;
            font-size: 1.2em;
            padding: 10px 15px;
            border-left: 5px solid #4b6cb7;
            margin-top: 30px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* ê¸°íƒ€ */
        .empty-state { text-align: center; padding: 40px; color: #a0aec0; }
        .file-upload { border: 2px dashed #4b6cb7; padding: 30px; text-align: center; border-radius: 15px; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        
        /* ì“°ê¸° ì—°ìŠµ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
        #writingCanvas { 
            border: 2px solid #4b6cb7; 
            background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 100%; /* ë°˜ì‘í˜• */
            height: auto;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding: 10px 0; }
            .sidebar h1 { margin-bottom: 10px; padding-bottom: 5px; }
            .sidebar-menu { display: flex; overflow-x: auto; padding: 0 10px; }
            .sidebar-menu a { flex-shrink: 0; padding: 10px 15px; border-left: none; border-bottom: 3px solid transparent; }
            .sidebar-menu a.active { border-bottom: 3px solid #a0c4ff; border-left: none; }
            .content-area { padding: 20px; }
            .stats { flex-direction: column; }
            .vocab-grid { grid-template-columns: 1fr; }
            .wordlist-table th, .wordlist-table td { font-size: 0.85em; padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>ğŸ‡¯ğŸ‡µ í†µí•© í•™ìŠµ íˆ´</h1>
        <nav class="sidebar-menu">
            <a href="#" class="active" onclick="switchTab('study', event)">ğŸ“š í™ˆ (ë‹¨ì–´ í•™ìŠµ)</a>
            <a href="#" onclick="switchTab('memory', event)">ğŸ’¡ ì•”ê¸° í…ŒìŠ¤íŠ¸</a>
            <a href="#" onclick="switchTab('write', event)">âœï¸ ì“°ê¸° ì—°ìŠµ</a>
            <a href="#" onclick="switchTab('add', event)">â• ë‹¨ì–´ ì¶”ê°€</a>
            <a href="#" onclick="switchTab('upload', event)">ğŸ“¤ CSV ì—…ë¡œë“œ</a>
        </nav>
    </div>

    <div class="content-area">
        <header class="content-header">
            <h2 id="currentTitle">ğŸ“š í™ˆ (ì˜¤ëŠ˜ì˜ ëœë¤ ë‹¨ì–´)</h2>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalWords">0</div>
                <div class="stat-label">ì „ì²´ ë‹¨ì–´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="learnedWords">0</div>
                <div class="stat-label">í•™ìŠµ ì™„ë£Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reviewWords">0</div>
                <div class="stat-label">ë¯¸í•™ìŠµ ë‹¨ì–´</div>
            </div>
        </div>

        <div id="studyTab" class="tab-content active">
            <div class="main-card">
                <div class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="searchInput" class="search-input" onkeyup="searchVocab()" placeholder="ğŸ” í•œì, íˆë¼ê°€ë‚˜, ëœ»ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>

                <div class="controls">
                    <button class="btn-primary" onclick="loadRandomWords()">ğŸ² ìƒˆë¡œìš´ 10ê°œ ë‹¨ì–´ ë³´ê¸°</button>
                    <button class="btn-primary" onclick="displayAllWordsByLevel()">ğŸ“– ì „ì²´ ë‹¨ì–´ ëª©ë¡ ë³´ê¸°</button> 
                    <button class="btn-danger" onclick="resetAllData()">ğŸš¨ ë‹¨ì–´ì¥ ì´ˆê¸°í™”</button> 
                </div>
                <div id="vocabListContainer">
                    <div id="vocabGrid" class="vocab-grid">
                        <div class="empty-state" id="emptyState" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>í˜„ì¬ ë‹¨ì–´ì¥ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.<br> 'ë‹¨ì–´ ì¶”ê°€' ë˜ëŠ” 'CSV ì—…ë¡œë“œ' íƒ­ì—ì„œ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="memoryTab" class="tab-content">
            <div class="main-card">
                <h2 style="margin-bottom: 20px;">ğŸ’¡ ì•”ê¸° í…ŒìŠ¤íŠ¸ (í”Œë˜ì‹œ ì¹´ë“œ)</h2>
                
                <div class="controls">
                    <select id="levelFilter" onchange="startMemoryDrill()">
                        <option value="All">ì „ì²´ ë ˆë²¨</option>
                        <option value="N1">N1</option>
                        <option value="N2">N2</option>
                        <option value="N3">N3</option>
                        <option value="N4">N4</option>
                        <option value="N5">N5</option>
                        <option value="N?">N? (ë¯¸ì§€ì •)</option>
                    </select>
                    <button class="btn-primary" onclick="startMemoryDrill()">â¡ï¸ ë‹¤ìŒ ë‹¨ì–´</button>
                    <button class="btn-success" onclick="if(currentMemoryWord) { markLearned(currentMemoryWord.id, true); startMemoryDrill(); }">âœ… ì•”ê¸° ì™„ë£Œ & ë‹¤ìŒ</button>
                </div>

                <div id="memoryCardContainer" class="vocab-grid" style="grid-template-columns: 1fr; margin-top: 0;">
                    <div id="memoryCard" class="memory-card" onclick="flipCard()">
                        <button class="speak-btn" id="memorySpeakBtn" onclick="event.stopPropagation(); speakWord(currentMemoryWord ? currentMemoryWord.hiragana : '')">ğŸ”Š</button>
                        <div id="memoryFront" class="front visible-content">ë‹¨ì–´ ì¤€ë¹„ ì¤‘...</div>
                        <div id="memoryBack" class="back hidden-content"></div>
                        <div id="memoryFooter" class="card-footer">í´ë¦­í•´ì„œ ëœ»ì„ í™•ì¸í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="writeTab" class="tab-content">
            <div class="main-card">
                <h2 style="margin-bottom: 20px;">âœï¸ ì“°ê¸° ì—°ìŠµ (í”Œë˜ì‹œ ì¹´ë“œ ë“œë¦´)</h2>
                
                <div class="controls">
                    <select id="writeLevelFilter" onchange="startWritingDrill()">
                        <option value="All">ì „ì²´ ë ˆë²¨</option>
                        <option value="N1">N1</option>
                        <option value="N2">N2</option>
                        <option value="N3">N3</option>
                        <option value="N4">N4</option>
                        <option value="N5">N5</option>
                        <option value="N?">N? (ë¯¸ì§€ì •)</option>
                    </select>
                    <button class="btn-primary" onclick="startWritingDrill()">â¡ï¸ ë‹¤ìŒ ë‹¨ì–´</button>
                </div>

                <div id="drillWordDisplay" style="text-align: center; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f7fafc;">
                    <p style="color: #666; font-size: 1.1em; margin-bottom: 5px;"><strong id="writingHint">ë‹¨ì–´ì˜ ëœ»ê³¼ ì½ëŠ” ë²•ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</strong></p>
                    <h3 id="drillTitle" style="font-size: 1.8em; color: #4b6cb7;">ì¤€ë¹„ ì¤‘...</h3>
                </div>

                <div class="writing-area" style="display: flex; flex-direction: column; align-items: center;">
                    <button class="speak-btn" id="writeSpeakBtn" onclick="event.stopPropagation(); speakWord(currentDrillWord ? currentDrillWord.hiragana : '')" style="position: static; color: #4b6cb7; margin-bottom: 10px;">ğŸ”Š ë‹¨ì–´ ì½ê¸°</button>
                    <canvas id="writingCanvas" width="540" height="200" style="max-width: 100%;"></canvas>
                    
                    <div class="correct-answer" id="correctAnswerDisplay" style="font-size: 3em; font-weight: bold; color: #e53e3e; min-height: 1.5em; margin: 15px 0;"></div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                        <button class="btn-primary" onclick="clearCanvas()">ğŸ“ ë‹¤ì‹œ ì“°ê¸°</button>
                        <button class="btn-success" onclick="showAnswer()">âœ… ì •ë‹µ ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="addTab" class="tab-content">
            <div class="main-card">
                <h2 style="margin-bottom: 20px;">â• ìƒˆ ë‹¨ì–´ ì§ì ‘ ì¶”ê°€í•˜ê¸°</h2>
                <div style="border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: bold; color: #4b6cb7;">í•œì (æ¼¢å­—)</label>
                        <input type="text" id="kanjiInput" placeholder="ä¾‹: é£Ÿã¹ã‚‹">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: bold; color: #4b6cb7;">íˆë¼ê°€ë‚˜ (èª­ã¿)</label>
                        <input type="text" id="hiraganaInput" placeholder="ä¾‹: ãŸã¹ã‚‹">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: bold; color: #4b6cb7;">ëœ» (æ„å‘³)</label>
                        <input type="text" id="meaningInput" placeholder="ä¾‹: ë¨¹ë‹¤">
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: bold; color: #4b6cb7;">JLPT ë ˆë²¨</label>
                        <select id="jlptInput">
                            <option value="N1" selected>N1 (ê³ ê¸‰)</option>
                            <option value="N2">N2</option>
                            <option value="N3">N3 (ì¤‘ê¸‰)</option>
                            <option value="N4">N4</option>
                            <option value="N5">N5 (ì´ˆê¸‰)</option>
                            <option value="N?">N? (ë¯¸ì§€ì •)</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addWord()">ë‹¨ì–´ì¥ì— ì¶”ê°€í•˜ê¸°</button>
                </div>
            </div>
        </div>
        <div id="uploadTab" class="tab-content">
            <div class="main-card">
                <h2 style="margin-bottom: 20px;">ğŸ“¤ CSV íŒŒì¼ ì—…ë¡œë“œ (ë‹¨ì–´ ì¶”ê°€)</h2>
                <div class="file-upload" onclick="document.getElementById('csvFile').click()">
                    <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(event)" style="display: none;">
                    <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                    <h3>í´ë¦­í•´ì„œ CSV íŒŒì¼ ì„ íƒ</h3>
                    <p style="color: #666; margin-top: 10px;">ê¸°ì¡´ ë‹¨ì–´ì¥ì— ë‹¨ì–´ë¥¼ **ì¶”ê°€**í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="csv-guide">
                    <h3 style="margin-bottom: 10px;">ğŸ“‹ CSV í˜•ì‹ ê°€ì´ë“œ (N1 íŒŒì¼ ê¸°ì¤€)</h3>
                    <p style="margin-bottom: 10px;">ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ë„¤ê°€ ì˜¬ë ¸ë˜ N1 íŒŒì¼ í˜•ì‹ì— ë§ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤:</p>
                    <pre style="background: #f0f4f8; padding: 10px; border-radius: 5px; overflow-x: auto; border: 1px solid #ddd;">í•œì,ëœ»,í’ˆì‚¬,íˆë¼ê°€ë‚˜,...</pre>
                    <p style="margin-top: 10px; color: #e53e3e; font-weight: bold;">[0]=í•œì, [1]=ëœ», [3]=íˆë¼ê°€ë‚˜ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤. ì²« ë²ˆì§¸ ì¤„(í—¤ë”)ì€ ë¬´ì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
        </div>

    <script>
        // â­ï¸ N5 ê¸°ë³¸ ë‹¨ì–´ 10ê°œ (ì´ˆê¸°í™” ë° ë¹„ì–´ ìˆì„ ë•Œ ëŒ€ë¹„)
        const defaultVocabularies = [
            { id: 101, kanji: 'ç§', hiragana: 'ã‚ãŸã—', meaning: 'ë‚˜, ì €', jlpt: 'N5', isLearned: false },
            { id: 103, kanji: 'å­¦æ ¡', hiragana: 'ãŒã£ã“ã†', meaning: 'í•™êµ', jlpt: 'N5', isLearned: false },
            { id: 104, kanji: 'å­¦ç”Ÿ', hiragana: 'ãŒãã›ã„', meaning: 'í•™ìƒ', jlpt: 'N5', isLearned: false },
            { id: 107, kanji: 'æœ¬', hiragana: 'ã»ã‚“', meaning: 'ì±…', jlpt: 'N5', isLearned: false },
            { id: 108, kanji: 'è¾æ›¸', hiragana: 'ã˜ã—ã‚‡', meaning: 'ì‚¬ì „', jlpt: 'N5', isLearned: false },
            { id: 138, kanji: 'é£Ÿã¹ã‚‹', hiragana: 'ãŸã¹ã‚‹', meaning: 'ë¨¹ë‹¤', jlpt: 'N5', isLearned: false },
            { id: 139, kanji: 'é£²ã‚€', hiragana: 'ã®ã‚€', meaning: 'ë§ˆì‹œë‹¤', jlpt: 'N5', isLearned: false },
            { id: 140, kanji: 'è¦‹ã‚‹', hiragana: 'ã¿ã‚‹', meaning: 'ë³´ë‹¤', jlpt: 'N5', isLearned: false },
            { id: 146, kanji: 'å¤§ãã„', hiragana: 'ãŠãŠãã„', meaning: 'í¬ë‹¤', jlpt: 'N5', isLearned: false },
            { id: 150, kanji: 'æ–°ã—ã„', hiragana: 'ã‚ãŸã‚‰ã—ã„', meaning: 'ìƒˆë¡­ë‹¤', jlpt: 'N5', isLearned: false },
        ];

        let vocabularies = [];
        const STORAGE_KEY = 'userVocabularies';
        // const GRAMMAR_MEMO_KEY = 'grammarMemoContent'; // ë¬¸ë²• ë©”ëª¨ì¥ ì œê±°
        const JLPT_ORDER = ['N1', 'N2', 'N3', 'N4', 'N5', 'N?'];
        
        let currentDisplayMode = 'random'; 
        let currentDrillWord = null; 
        let currentMemoryWord = null; 

        // ------------------------------------
        // 1. ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° ê´€ë¦¬
        // ------------------------------------

        function saveVocabularies() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(vocabularies));
            updateStats();
        }

        function generateUniqueId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        function updateStats() {
            const total = vocabularies.length;
            const learned = vocabularies.filter(word => word.isLearned).length;
            const review = total - learned; 

            document.getElementById('totalWords').textContent = total;
            document.getElementById('learnedWords').textContent = learned;
            document.getElementById('reviewWords').textContent = review;

            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                const isSearching = document.getElementById('searchInput').value.trim() !== '';

                if (total === 0 || (isSearching && document.getElementById('vocabGrid') && document.getElementById('vocabGrid').childElementCount === 0)) {
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            }
        }
        
        // ------------------------------------
        // 2. ğŸ”Š ë‹¨ì–´ ì½ì–´ì£¼ê¸° ê¸°ëŠ¥ (TTS)
        // ------------------------------------
        
        const synth = window.speechSynthesis;
        let jpVoice = null;

        function initializeSpeechSynthesis() {
            if (!synth) {
                console.warn("Speech Synthesis API is not supported by this browser.");
                return;
            }
            
            const populateVoices = () => {
                jpVoice = synth.getVoices().find(voice => voice.lang.startsWith('ja-'));
            };

            // Voices might not be loaded immediately
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoices;
            }
            populateVoices(); 
        }

        function speakWord(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ja-JP'; 
            
            // ì¼ë³¸ì–´ ëª©ì†Œë¦¬ë¥¼ ì°¾ì•˜ë‹¤ë©´ ì„¤ì •
            if (jpVoice) {
                utter.voice = jpVoice;
            } else {
                 // ì—†ë‹¤ë©´ ê¸°ë³¸ ì¼ë³¸ì–´ ì„¤ì •ì„ ì‚¬ìš©í•˜ë„ë¡ ì‹œë„ (ë¸Œë¼ìš°ì € ê¸°ë³¸ê°’)
                 console.warn("Japanese voice not found, using default voice.");
            }
            
            synth.speak(utter);
        }


        // ------------------------------------
        // 3. UI ë° íƒ­ ì „í™˜
        // ------------------------------------

        function switchTab(tabId, event) {
            if (event) event.preventDefault();
            
            // ë©”ë‰´ í™œì„±í™”
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar-menu a[onclick*="${tabId}"]`).classList.add('active');

            // ë‚´ìš© í‘œì‹œ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabId}Tab`).classList.add('active');
            
            const titleMap = {
                'study': 'ğŸ“š í™ˆ (ì˜¤ëŠ˜ì˜ ëœë¤ ë‹¨ì–´)',
                'memory': 'ğŸ’¡ ì•”ê¸° í…ŒìŠ¤íŠ¸',
                'write': 'âœï¸ ì“°ê¸° ì—°ìŠµ',
                'add': 'â• ë‹¨ì–´ ì¶”ê°€',
                'upload': 'ğŸ“¤ CSV ì—…ë¡œë“œ'
            };
            document.getElementById('currentTitle').textContent = titleMap[tabId];


            if (tabId === 'study') {
                document.getElementById('searchInput').value = '';
                if (currentDisplayMode === 'all') {
                     displayAllWordsByLevel(); 
                } else {
                    loadRandomWords(); 
                }
            } else if (tabId === 'write') {
                startWritingDrill(); 
            } else if (tabId === 'memory') {
                startMemoryDrill();
            }
        }

        function createVocabCard(word) {
            const card = document.createElement('div');
            card.className = `vocab-card ${word.isLearned ? 'learned' : ''}`;
            
            card.onclick = (e) => {
                if (!e.target.closest('.card-actions') && !e.target.closest('.speak-btn')) {
                     switchTab('memory');
                     startMemoryDrill(word.id);
                }
            }; 
            
            const actionButton = word.isLearned 
                ? `<button class="btn-secondary" onclick="event.stopPropagation(); markLearned(${word.id}, false); updateDisplayAfterAction();">ğŸ”„ ì™„ë£Œ ì·¨ì†Œ</button>`
                : `<button class="btn-success" onclick="event.stopPropagation(); markLearned(${word.id}, true); updateDisplayAfterAction();">âœ… í•™ìŠµ ì™„ë£Œ</button>`;

            card.innerHTML = `
                <button class="speak-btn" onclick="event.stopPropagation(); speakWord('${word.hiragana}')">ğŸ”Š</button>
                <div class="kanji">${word.kanji}</div>
                <div class="hiragana">${word.hiragana}</div>
                <div class="meaning">${word.meaning} (${word.jlpt})</div>
                <div class="card-actions" onclick="event.stopPropagation()">
                    ${actionButton}
                    <button class="btn-danger" onclick="deleteWord(${word.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            `;
            return card;
        }
        
        // (displayVocabGrid, displayAllWordsByLevel, updateDisplayAfterAction ë“± ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ëŒ€ë¶€ë¶„ ìœ ì§€)
        function displayVocabGrid(words, mode = 'random') {
            const container = document.getElementById('vocabListContainer');
            if (!container.querySelector('.vocab-grid')) {
                 container.innerHTML = `<div id="vocabGrid" class="vocab-grid"></div>`;
            }
            const grid = document.getElementById('vocabGrid');
            grid.innerHTML = ''; 
            currentDisplayMode = mode;

            if (words.length === 0 && vocabularies.length > 0) {
                 grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">ğŸ‰</div>
                        <p>ì§€ê¸ˆì€ í‘œì‹œí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ í•„í„°ë¥¼ ì§€ìš°ê±°ë‚˜ 'ì „ì²´ ë‹¨ì–´ ëª©ë¡ ë³´ê¸°'ë¥¼ ì‚¬ìš©í•´ ë³´ì„¸ìš”.</p>
                    </div>
                `;
            } else if (vocabularies.length === 0) {
                 grid.innerHTML = `
                    <div class="empty-state" id="emptyState" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>í˜„ì¬ ë‹¨ì–´ì¥ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.<br> 'ë‹¨ì–´ ì¶”ê°€' ë˜ëŠ” 'CSV ì—…ë¡œë“œ' íƒ­ì—ì„œ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”!</p>
                    </div>
                `;
            } else {
                words.forEach(word => {
                    grid.appendChild(createVocabCard(word));
                });
            }
            updateStats();
        }

        function loadRandomWords() {
            document.getElementById('searchInput').value = ''; 
            if (vocabularies.length === 0) {
                displayVocabGrid([], 'random');
                return;
            }
            const unleanedWords = vocabularies.filter(word => !word.isLearned);
            const sourceList = unleanedWords.length > 0 ? unleanedWords : vocabularies;
            const shuffled = sourceList.sort(() => 0.5 - Math.random());
            const selectedWords = shuffled.slice(0, 10);
            
            displayVocabGrid(selectedWords, 'random');
        }

        // (ì´í•˜ ë‹¨ì–´ ê´€ë¦¬ í•¨ìˆ˜ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)

        // ------------------------------------
        // 4. ğŸ’¡ ì•”ê¸° í…ŒìŠ¤íŠ¸ (í”Œë˜ì‹œ ì¹´ë“œ)
        // ------------------------------------
        
        function startMemoryDrill(wordId) {
            const memoryCard = document.getElementById('memoryCard');
            const memoryFront = document.getElementById('memoryFront');
            const memoryBack = document.getElementById('memoryBack');
            const memoryFooter = document.getElementById('memoryFooter');
            const levelFilter = document.getElementById('levelFilter').value;
            
            // â­ï¸ ë ˆë²¨ í•„í„°ë§
            const filteredWords = vocabularies.filter(word => 
                levelFilter === 'All' || word.jlpt === levelFilter
            );

            if (filteredWords.length === 0) {
                 memoryFront.textContent = `ì„ íƒëœ ë ˆë²¨(${levelFilter})ì˜ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                 memoryBack.textContent = '';
                 memoryCard.classList.remove('flipped');
                 memoryFooter.textContent = 'ë‹¤ë¥¸ ë ˆë²¨ì„ ì„ íƒí•˜ê±°ë‚˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
                 currentMemoryWord = null;
                 return;
            }

            let word;
            if (wordId) {
                word = filteredWords.find(w => w.id === wordId);
                // íŠ¹ì • IDë¡œ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ í•„í„°ë§ë˜ì—ˆë‹¤ë©´ ëœë¤ìœ¼ë¡œ ë‹¤ì‹œ ì„ íƒ
                if (!word) wordId = null;
            }
            
            if (!wordId) {
                // ëœë¤ìœ¼ë¡œ ë‹¨ì–´ ì„ íƒ (ë¹„í•™ìŠµ ë‹¨ì–´ ìš°ì„ )
                const unleanedWords = filteredWords.filter(w => !w.isLearned);
                const sourceList = unleanedWords.length > 0 ? unleanedWords : filteredWords;
                const randomIndex = Math.floor(Math.random() * sourceList.length);
                word = sourceList[randomIndex];
            }
            
            if (!word) {
                 // í•„í„°ë§ í›„ ë‹¨ì–´ê°€ ì—†ì„ ê²½ìš°ì˜ ì˜ˆì™¸ ì²˜ë¦¬ (ì‹¤í–‰ë  ê°€ëŠ¥ì„±ì€ ë‚®ìŒ)
                 memoryFront.textContent = 'ë‹¨ì–´ ì¤€ë¹„ ì˜¤ë¥˜.';
                 return;
            }

            currentMemoryWord = word;
            memoryCard.classList.remove('flipped');
            
            // ì•ë©´ (ì½ê¸° + í•œì)
            memoryFront.innerHTML = `${word.kanji}<br><span style="font-size: 0.5em; opacity: 0.7;">(${word.hiragana})</span>`;
            memoryFront.classList.add('visible-content');
            memoryFront.classList.remove('hidden-content');
            
            // ë’·ë©´ (ëœ»)
            memoryBack.innerHTML = `<span style="font-size: 0.6em; color: #4b6cb7;">ëœ» (${word.jlpt})</span><br>${word.meaning}`;
            memoryBack.classList.add('hidden-content');
            memoryBack.classList.remove('visible-content');

            memoryFooter.textContent = 'í´ë¦­í•´ì„œ ëœ»ì„ í™•ì¸í•˜ì„¸ìš”';
            
            // ë°œìŒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            document.getElementById('memorySpeakBtn').onclick = (e) => {
                e.stopPropagation();
                speakWord(word.hiragana);
            };
        }

        function flipCard() {
            if (!currentMemoryWord) return;
            const memoryCard = document.getElementById('memoryCard');
            const memoryFront = document.getElementById('memoryFront');
            const memoryBack = document.getElementById('memoryBack');
            
            memoryCard.classList.toggle('flipped');
            
            if (memoryCard.classList.contains('flipped')) {
                memoryFront.classList.add('hidden-content');
                memoryFront.classList.remove('visible-content');
                memoryBack.classList.add('visible-content');
                memoryBack.classList.remove('hidden-content');
            } else {
                memoryFront.classList.add('visible-content');
                memoryFront.classList.remove('hidden-content');
                memoryBack.classList.add('hidden-content');
                memoryBack.classList.remove('visible-content');
            }
        }


        // ------------------------------------
        // 5. âœï¸ ì“°ê¸° ì—°ìŠµ (ìº”ë²„ìŠ¤)
        // ------------------------------------
        
        const canvas = document.getElementById('writingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function initializeCanvas() { 
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';
            ctx.fillStyle = '#fff';
            
            canvas.width = 540;
            canvas.height = 200;
            
            clearCanvas();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì •ì˜
            canvas.onmousedown = (e) => startDrawing(e.offsetX, e.offsetY);
            canvas.onmousemove = (e) => draw(e.offsetX, e.offsetY);
            canvas.onmouseup = stopDrawing;
            canvas.onmouseout = stopDrawing;

            // í„°ì¹˜ ì´ë²¤íŠ¸ ì¬ì •ì˜
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
            };
            canvas.ontouchmove = (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                draw(touch.clientX - rect.left, touch.clientY - rect.top);
            };
            canvas.ontouchend = stopDrawing;
        }

        function startWritingDrill(wordId) {
            const levelFilter = document.getElementById('writeLevelFilter').value;
            
            // â­ï¸ ë ˆë²¨ í•„í„°ë§
            const filteredWords = vocabularies.filter(word => 
                levelFilter === 'All' || word.jlpt === levelFilter
            );

            if (filteredWords.length === 0) {
                 document.getElementById('drillTitle').textContent = `ì„ íƒëœ ë ˆë²¨(${levelFilter})ì˜ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                 document.getElementById('writingHint').textContent = 'ë‹¤ë¥¸ ë ˆë²¨ì„ ì„ íƒí•˜ê±°ë‚˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
                 document.getElementById('correctAnswerDisplay').textContent = '';
                 clearCanvas();
                 currentDrillWord = null;
                 return;
            }


            let word;
            if (wordId) {
                word = filteredWords.find(w => w.id === wordId);
                if (!word) wordId = null;
            }
            
            if (!wordId) {
                const unleanedWords = filteredWords.filter(w => !w.isLearned);
                const sourceList = unleanedWords.length > 0 ? unleanedWords : filteredWords;
                const randomIndex = Math.floor(Math.random() * sourceList.length);
                word = sourceList[randomIndex];
            }
            
            if (!word) {
                 document.getElementById('drillTitle').textContent = 'ë‹¨ì–´ ì¤€ë¹„ ì˜¤ë¥˜.';
                 return;
            }


            currentDrillWord = word;
            document.getElementById('drillTitle').textContent = `[${word.jlpt}] - ${word.meaning}`;
            document.getElementById('writingHint').textContent = `ì½ê¸°: ${word.hiragana}`;
            
            clearCanvas();
            document.getElementById('correctAnswerDisplay').textContent = '';
            
            document.getElementById('writeSpeakBtn').onclick = (e) => {
                e.stopPropagation();
                speakWord(word.hiragana);
            };
        }

        function showAnswer() { 
            if (currentDrillWord) { 
                document.getElementById('correctAnswerDisplay').textContent = currentDrillWord.kanji; 
            }
        }
        
        function startDrawing(x, y) { isDrawing = true; [lastX, lastY] = [x, y]; }
        function draw(x, y) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(document.getElementById('correctAnswerDisplay')) {
                 document.getElementById('correctAnswerDisplay').textContent = '';
            }
        }

        // ------------------------------------
        // 6. ì´ˆê¸° ì‹¤í–‰ ë¡œì§
        // ------------------------------------
        
        window.onload = function() {
            const storedVocabs = localStorage.getItem(STORAGE_KEY);

            if (storedVocabs === null || storedVocabs === '[]' || JSON.parse(storedVocabs).length === 0) {
                vocabularies = JSON.parse(JSON.stringify(defaultVocabularies));
                saveVocabularies();
            } else {
                vocabularies = JSON.parse(storedVocabs);
            }
            
            initializeSpeechSynthesis(); // TTS ì´ˆê¸°í™”
            initializeCanvas();
            updateStats();
            
            // â­ï¸ ì´ˆê¸° í™”ë©´ì€ 'study' íƒ­ìœ¼ë¡œ ì„¤ì • (ëœë¤ 10ê°œ ë‹¨ì–´)
            switchTab('study'); 
        };
    </script>
</body>
</html>